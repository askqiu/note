# 利用xxe打ssrf拿aws角色凭证
## 元数据概念
作为渗透测试工程师，了解 AWS 元数据对于在云环境中的渗透测试和安全分析非常重要。以下是你需要学习的几个关键知识领域：

### 1. **AWS 元数据服务的工作原理**：
   - **元数据服务**：AWS EC2 实例中的元数据服务是通过 `169.254.169.254` 这个特殊的 IP 地址访问的，提供有关实例的信息，如实例 ID、实例类型、区域、AMI ID，以及 IAM 角色的凭据。
   - **元数据版本**：AWS 提供两种版本的元数据服务：
     - **v1**：无身份验证要求，易受 SSRF（服务器端请求伪造）攻击。
     - **v2**：引入了基于会话令牌的身份验证，增强了安全性。

### 2. **元数据的渗透测试场景**：
   - **SSRF 攻击**：利用 XXE（XML 外部实体）或 SSRF 漏洞，向 AWS 元数据服务发起请求，获取到敏感信息（如 IAM 角色凭据）。
   - **IAM 凭据的滥用**：通过获取元数据中的 IAM 凭据，攻击者可以在 AWS 环境中提升权限或执行未经授权的操作。

### 3. **重要的元数据路径**：
   - **实例元数据路径**：`http://169.254.169.254/latest/meta-data/` 下有不同的资源，以下路径是渗透测试中常用的：
     - ` ![[Pasted image 20240916153747.png]]`：返回实例 IAM 角色的凭据。
     - `instance-id`：返回实例的 ID。
     - `public-keys/`：返回与实例关联的公钥信息。
   - **实例用户数据**：`http://169.254.169.254/latest/user-data/`，有时用户数据包含初始化脚本、凭据或敏感信息。

### 4. **防御与绕过技术**：
   - 学习 AWS 如何通过 **元数据服务v2** 进行增强的安全防护，了解会话令牌的使用，研究是否存在绕过此防护的方式。
   - 学习 AWS 的 **IAM 角色** 设计，如何限制 IAM 角色的权限，以防止攻击者滥用获取的凭据。
   - **网络隔离和访问控制**：如何通过 AWS Security Group 和网络 ACL 限制对元数据服务的访问。

### 5. **实践工具**：
   - **Metasploit**：利用内置的 SSRF 模块来攻击元数据服务。
   - **Burp Suite**：通过代理工具进行 SSRF 攻击，捕获和修改请求，访问元数据。
   - **CloudBrute**：用于枚举云端元数据，找出潜在的敏感信息。

### 6. **学习 AWS 安全最佳实践**：
   - 如何配置安全组和防火墙来限制对元数据服务的访问。
   - 学习 **AWS CloudTrail**，了解如何使用日志记录来监控实例元数据的访问。
   - 配置 **VPC Endpoint** 来控制对外部资源的访问。

通过学习以上知识，你将更好地理解 AWS 元数据服务如何工作，以及如何在渗透测试中识别并利用与元数据相关的潜在安全漏洞。

## 靶场实践
通过xxe漏洞，结合路径去获取元数据，看到admin，
![[Pasted image 20240916153811.png]]
继续拼接，获得ak
![[Pasted image 20240916153950.png]]